<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MBorg</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,600,800" rel="stylesheet" type="text/css">
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet" type="text/css">
    <link href="css/mborg.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-stars.css" rel="stylesheet" type="text/css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MBorg</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="javascript:upload()">Upload</a></li>
                </ul>
                <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">
                                <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                            </div>
                            <input type="text" class="form-control" placeholder="Search" id="txtsearch">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4" id="tree_container"></div>
            <div class="col-md-8" id="links_container">
                <div class="link-commands">
                    <span id="info"></span>
                    <a href="#"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add</a>
                </div>
                <ul class="list-group" id="links"></ul>
            </div>
        </div>
    </div>
    <!-- template -->
    <script id="link-item-template" type="text/x-handlebars-template">
        <li class="list-group-item bookmark" data-folder-id="{{folderId}}" style="display: none">
            <a href="{{href}}"><img width="16" src="{{icon}}">{{text}}</a>
            <div class="link-options pull-right">
                <a href="#"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
                <a href="#"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
            </div>
            <div class="link-stars br-theme-bootstrap-stars" data-rating="{{rating}}">
                <select>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </li>
    </script>
    <!-- -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-treeview.min.js"></script>
    <script type="text/javascript" src="js/underscore-min.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
    <script type="text/javascript" src="js/jquery.barrating.min.js"></script>
    <script type="text/javascript" src="js/rx.lite.min.js"></script>
    <script type="text/javascript">
    var _root;
    var linkItemTemplate;

    $(function load() {
        // preparo i template
        linkItemTemplate = Handlebars.compile($('#link-item-template').html());
        //
        prepareSearch();
        // // leggo i dati da /data/tree.json
        // $.getJSON('/data/tree.json')
        //     .then(function(data) {
        //         _root = data;
        //         $('<div class="tree" id="tree">')
        //             .appendTo('#tree_container')
        //             .treeview({
        //                 data: _root
        //             })
        //             .on('nodeSelected', nodeSelected);
        //         makeLinks($('#links'), _root);
        //     })
        //     .fail(function() {
        //         alert('error retrieving tree data');
        //     });
        fake();
    });

    function makeLinks(container, nodes) {
        _.chain((function extractLinks(nodes) {
                return _.flatten(
                    _.map(nodes, function(node) {
                        return (node.links || [])
                            .concat(extractLinks(node.nodes));
                    })
                );
            })(nodes))
            .sortBy('text')
            .each(function createDom(link) {
                $(linkItemTemplate(link))
                    .data('source', link)
                    .find('.link-stars select')
                    .barrating({
                        initialRating: link.rating,
                        onSelect: ratingChanged
                    })
                    .end()
                    .appendTo(container);
            });
    }

    function nodeSelected(event, data) {
        $('#info').html('');
        $('.bookmark').hide().filter('[data-folder-id=' + data.folderId + ']').show();
    }

    function ratingChanged(value, text, event) {
        // TODO: event è valorizzato solo su interazione dell'utente
        //  il metodo 'set' produce event undefined
        //  per capire a quale link si fa riferimento accedere al padre di event.target
    }

    function upload() {
        // TODO: gestire upload file
    }

    function fake() {
        // simulo upload di un file bookmarks nel formato NETSCAPE-Bookmark-file-1
        $.get('/data/bookmarks_16_12_15.html')
            .then(function(data) {
                var context = $.parseHTML(data);
                var root = [createFolder($(context).find('dt:first>h3').html(), 0)];
                parseDL(root[0], $(context).find('dl').first(), 0);
                return root;
            })
            .then(function(root) {
                // TODO aggiornare _root e salvare /data/tree.json
                // in questa simulazione ricarico il controllo
                _root = root;
                $('<div class="tree" id="tree">')
                    .appendTo('#tree_container')
                    .treeview({
                        data: _root
                    })
                    .on('nodeSelected', nodeSelected);
                makeLinks($('#links'), _root);
            })
            .fail(function() {
                alert('error retrieving tree data');
            });
    }

    function parseDL(parent, context, folderId) {
        context.children('dt').each(function() {
            var $self = $(this);
            if ($self.has('h3').length) { // folder
                var folder = createFolder($self.find('h3').first().html(), ++folderId);
                (parent.nodes || (parent.nodes = [])).push(folder);
                parseDL(folder, $self.children('dl'), folderId);
            } else { // node
                parseLink($self, parent);
            }
        });
    }

    function parseLink($dt, parent) {
        var link = $dt.find('a').first();
        (parent.links || (parent.links = [])).push(createLink(link.attr('href'), link.attr('icon'), link.html(), parent.folderId));
    }

    function createFolder(text, folderId) {
        return {
            "text": text,
            "folderId": folderId
        };
    }

    function createLink(href, icon, text, folderId) {
        return {
            "href": href,
            "icon": icon,
            "text": text,
            "rating": 1,
            "folderId": folderId
        };
    }

    function prepareSearch() {
        var searchEl = $('#txtsearch');
        Rx.Observable.merge(
                Rx.Observable.fromEvent(searchEl, 'keyup'),
                Rx.Observable.fromEvent(searchEl, 'blur'))
            .map(function(e) {
                return e.target.value.trim();
            })
            .filter(function(text) {
                return text.length === 0 || text.length >= 2;
            })
            .debounce(500) //se non succede più niente per 500ms prosegue
            .distinctUntilChanged() //solo quando cambia
            .subscribe(
                function(term) {
                    // in ogni caso deleleziono la cartella
                    _.each($('#tree').treeview(true).getSelected(),
                        function(node) {
                            $('#tree').treeview('unselectNode', node);
                        });
                    if (_.isEmpty(term)) {
                        // TODO: selezionare l'ultimo nodo selezionato
                        $('#info').html('');
                        $('.bookmark').hide();
                    } else {
                        var re = new RegExp(term, 'i');
                        $('.bookmark')
                            .hide()
                            .filter(function(index, el) {
                                // TODO: cercare anche in altre proprietà
                                return re.test($(el).data('source').text);
                            })
                            .do(function() {
                                $('#info').html('Found ' + this.length);
                            })
                            .show();
                    }
                });
    }

    //esegue una funziona all'interno della chain
    $.fn.do = function(func) {
        if (func) {
            func.apply(this);
        }
        return this;
    } 
    </script>
</body>

</html>
