<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MBorg</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,600,800" rel="stylesheet" type="text/css">
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet" type="text/css">
    <link href="css/mborg.css" rel="stylesheet" type="text/css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MBorg</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="javascript:upload()">Upload</a></li>
                </ul>
                <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></div>
                            <input type="text" class="form-control" placeholder="Search">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4" id="tree_container"></div>
            <div class="col-md-8">Content</div>
        </div>
    </div>
    <!-- -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-treeview.min.js"></script>
    <script type="text/javascript">
    var _root;

    $(function load() {
        // leggo i dati da /data/tree.json
        $.getJSON('/data/tree.json')
            .then(function(data) {
                _root = data;
                $('<div class="tree">')
                    .appendTo('#tree_container')
                    .treeview({
                        data: _root
                    })
                    .on('nodeSelected', nodeSelected);
            })
            .fail(function() {
                alert('error retrieving tree data');
            });
    });

    function nodeSelected(event, data) {
        // Your logic goes here
        console.log(event.target, data);
    }

    function upload() {
        // simulo upload di un file bookmarks nel formato NETSCAPE-Bookmark-file-1
        $.get('/data/bookmarks_16_12_15.html')
            .then(function(data) {
                var context = $.parseHTML(data);
                var root = [createFolder($(context).find('dt:first>h3').html())];
                parseDL(root[0], $(context).find('dl').first());
                return root;
            })
            .then(function(root) {
                // TODO aggiornare _root e salvare /data/tree.json
                // in questa simulazione ricarico il controllo
                $('<div class="tree">')
                    .appendTo('#tree_container')
                    .treeview({
                        data: root
                    })
                    .on('nodeSelected', nodeSelected);
            })
            .fail(function() {
                alert('error retrieving tree data');
            });
    }

    function parseDL(parent, context) {
        context.children('dt').each(function(index) {
            var $self = $(this);
            if ($self.has('h3').length) { // folder
                var folder = createFolder($self.find('h3').first().html());
                (parent.nodes || (parent.nodes = [])).push(folder);
                parseDL(folder, $self.children('dl'));
            } else { // node
                parseLink($self, parent);
            }
        });
    }

    function parseLink($dt, parent) {
        var link = $dt.find('a').first();
        (parent.links || (parent.links = [])).push( createLink(link.attr('href'), link.attr('icon'), link.html()) );
    }

    function createFolder(text) {
        return {
            "text": text
        };
    }

    function createLink(href, icon, text) {
        return {
            "href": href,
            "icon": icon,
            "text": text
        };
    }
    </script>
</body>

</html>
