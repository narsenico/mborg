<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MBorg</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,600,800" rel="stylesheet" type="text/css">
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet" type="text/css">
    <link href="css/mborg.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-stars.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="css/toastr.min.css">
    <link rel="stylesheet" type="text/css" href="css/Gubja.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body class="mborg">
    <div class="navbar">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">MBorg</a>
            <div class="navbar-fullsize">
                <div class="input-group">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
                    <input type="text" class="form-control" id="txtsearch" aria-label="Search" placeholder="Search" disabled>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-md-4">
                <div class="tree" id="folders"></div>
                <div class="tree list-group">
                    <a href="#" class="list-group-item" id="itemsearch" style="display: none">
                        <span class="badge">0</span> Search
                    </a>
                </div>
                <div class="input-group">
                    <span class="input-group-btn">
                    <span class="btn btn-primary btn-file">
                        Import file <input type="file" id="ctlfile">
                    </span>
                    </span>
                    <input type="text" class="form-control" readonly>
                </div>
            </div>
            <div class="col-md-8">
                <ul class="list-group" id="links"></ul>
            </div>
        </div>
        <button id="btnadd" type="button" class="btn btn-circle ripple-effect btn-primary fixed bottom right" aria-label="add new link" title="add new link" style="display: none"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
    </div>
    <!-- template -->
    <script id="link-item-template" type="text/x-handlebars-template">
        <li class="list-group-item bookmark {{status}}" data-folder-id="{{folderId}}" style="display: none">
            <div><img width="16" src="{{icon}}"><span class="link-title" data-editable="text">{{text}}</span></div>
            <a href="{{href}}" data-editable="href">{{href}}</a>
            <div class="link-options pull-right">
                <a href="#" class="link-option-edit" aria-label="edit bookmark" title="edit bookmark"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
                <a href="#" class="link-option-edit-ok" aria-label="confirm changes" title="confirm changes"><span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span></a>
                <a href="#" class="link-option-edit-cancel" aria-label="cancel changes" title="cancel changes"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></a>
                <a href="#" class="link-option-remove" aria-label="remove bookmark" title="remove bookmark"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
            </div>
            <div class="link-stars br-theme-bootstrap-stars" data-rating="{{rating}}">
                <select>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </li>
    </script>
    <!-- -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-treeview.min.js"></script>
    <script type="text/javascript" src="js/underscore-min.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
    <script type="text/javascript" src="js/jquery.barrating.min.js"></script>
    <script type="text/javascript" src="js/rx.lite.min.js"></script>
    <script type="text/javascript" src="js/toastr.min.js"></script>
    <script type="text/javascript" src="js/Gubja.js"></script>
    <script type="text/javascript">
    //
    var linkItemTemplate;
    $(function load() {
        // opzioni per i toast
        toastr.options.positionClass = 'toast-top-right';
        // preparo i template
        linkItemTemplate = Handlebars.compile($('#link-item-template').html());
        //
        prepareSearch();
        // // leggo i dati da /data/tree.json
        // $.getJSON('/data/tree.json')
        //     .then(function(data) {
        //          ...
        //     })
        //     .fail(function() {
        //         alert('error retrieving tree data');
        //     });
        //fake();
        // prevengo il refresh della pagina se digitato enter nella casella di ricerca
        $('#txtsearch').on('keydown', function(event) {
            if (event.which == 13) {
                event.preventDefault();
                event.stopPropagation();
                performSearch($('#txtsearch').val());
            }
        });
        // alla selezione di #itemsearch ribadisco la ricerca
        $('#itemsearch').on('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).addClass('active');
            var term = $('#txtsearch').data('last-term');
            $('#txtsearch').val(term);
            performSearch(term);
        });
        // gestisco l'upload del file
        $('#ctlfile').on('change', function(event) {
            var ff = event.target.files[0];
            if (ff) {
                // considero solo i file di tipo text/html
                if (!ff.type.match('html')) {
                    toastr.error('<b>' + ff.name + '</b> is not a valid <a href="https://msdn.microsoft.com/en-us/library/aa753582(v=vs.85).aspx">NETSCAPE-Bookmark-file-1</a> file.');
                } else {
                    $(this).parents('.input-group').find(':text').val(ff.name);
                    var reader = new FileReader();
                    reader.onload = $.proxy(loadFile, this, ff);
                    // leggo il contenuto del file come stringa UTF-8
                    reader.readAsText(ff);
                }
            }
        });
        // gestisco creazione nuovo link
        $('#btnadd').click(function(event) {
            event.preventDefault();
            event.stopPropagation();
            prepareNewLink();
        });
    }); // end load

    function loadFile(file, event) {
        if (/^\<\!DOCTYPE NETSCAPE\-Bookmark\-file\-1\>/.test(event.target.result)) {
            var context = $.parseHTML(event.target.result);
            var root = parseBookmarkFile(context);
            createTreeView(root);
            toastr.success('Import complete');
        } else {
            toastr.error('<b>' + file.name + '</b> is not a valid <a href="https://msdn.microsoft.com/en-us/library/aa753582(v=vs.85).aspx">NETSCAPE-Bookmark-file-1</a> file.');
        }
    }

    function createTreeView(root) {
        $('#folders')
            .treeview({
                data: root
            })
            .on('nodeSelected', nodeSelected);
        makeLinks($('#links'), root);
        $('#txtsearch').prop('disabled', false);
        $('#btnadd').show();
    }

    function makeLinks(container, nodes) {
        _.chain((function extractLinks(nodes) {
                return _.flatten(
                    _.map(nodes, function(node) {
                        return (node.links || [])
                            .concat(extractLinks(node.nodes));
                    })
                );
            })(nodes)) // estraggo tutti i link di tutte i nodi/cartella
            .sortBy('text') //  ordino per il testo
            .each($.proxy(createLinkDom, this, container)); // creo l'elemento
    }

    function createLinkDom(container, link) {
        return $(linkItemTemplate(link))
            .data('source', link)
            .find('.link-stars select') // gesisco rating
            .barrating({
                initialRating: link.rating,
                onSelect: ratingChanged
            })
            .end() // ritorno a .bookmark
            .find('.link-option-edit') // gestisco pulsante edit
            .click(function(event) {
                event.preventDefault();
                event.stopPropagation();
                beginEditMode(link, $(this).closest('.bookmark'));
            })
            .end() // ritorno a .bookmark
            .find('.link-option-edit-ok') // gestisco pulsante fine edit
            .click(function(event) {
                event.preventDefault();
                event.stopPropagation();
                endEditMode(link, $(this).closest('.bookmark'));
            })
            .end() // ritorno a .bookmark     
            .find('.link-option-edit-cancel') // gestisco pulsante annulla edit
            .click(function(event) {
                event.preventDefault();
                event.stopPropagation();
                endEditMode(link, $(this).closest('.bookmark'), true);
            })
            .end() // ritorno a .bookmark                     
            .find('.link-option-remove') // gestisco pulsante remove
            .click(function(event) {
                event.preventDefault();
                event.stopPropagation();
                removeLink($(this).closest('.bookmark'));
            })
            .end() // ritorno a .bookmark
            .find('[data-editable]') // gestisco tutti i campi editabili
            .on('keydown', function(event) {
                if (event.which == 13) { // enter (conferma)
                    endEditMode(link, $(this).closest('.bookmark'));
                } else if (event.which == 27) { // esc (annulla)
                    endEditMode(link, $(this).closest('.bookmark'), true);
                    // } else if (event.which == 9) { // tab
                    //     // TODO: non funziona -> $(this).closest('.bookmark').find('[data-editable]').gotoNext().focus();
                } else {
                    return true;
                }
            })
            .end() // ritorno a .bookmark
            .find('[data-editable="href"]')
            .click(function(event) {
                // se in edit prevengo la selezione del link
                if ($(this).closest('.bookmark').is('.editable')) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            })
            .end() // ritorno a .bookmark
            .appendTo(container);
    }

    function nodeSelected(event, data) {
        $('#itemsearch').removeClass('active');
        $('#btnadd').show();
        $('.bookmark.enabled')
            .hide()
            .filter('.enabled[data-folder-id=' + data.folderId + ']')
            .show();
    }

    function ratingChanged(value, text, event) {
        // TODO: event è valorizzato solo su interazione dell'utente
        //  il metodo 'set' produce event undefined
        //  per capire a quale link si fa riferimento accedere al padre di event.target
    }

    function beginEditMode(link, $bookmark) {
        $bookmark
            .addClass('editable')
            .find('[data-editable]')
            .attr('contenteditable', true)
            .first().focus(); // focus al primo elemento editabile
    }

    function endEditMode(link, $bookmark, cancel) {
        // se annullo l'edit di un link nuovo lo elimino direttamente
        if (cancel && $bookmark.is('.new')) {
            deleteLink($bookmark);
        } else {
            if (cancel) {
                $bookmark
                    .find('[data-editable=text]').html(link.text).end()
                    .find('[data-editable=href]').html(link.href);
            } else {
                // TODO: eseguire dei controlli formali sui dati modificati (es: text o href non possono essere vuoti)                
                $bookmark
                    .removeClass('new')
                    .find('[data-editable=text]').copyHtmlTo(link, 'text').end()
                    .find('[data-editable=href]').copyHtmlTo(link, 'href').attr('href', link.href);
            }
            // esco dalla modalità di edit
            $bookmark
                .removeClass('editable')
                .find('[data-editable]')
                .attr('contenteditable', 'inherit')
                .blur(); // tolgo il focus
        }
    }

    function removeLink($bookmark) {
        // la rimozione è solo logica, i link rimossi non verranno mostrati
        // la rimozione fisica sarà effettuata solo durante il salvataggio dei dati sul server
        var link = $bookmark.data('source');
        var node = getNodeByFolderId(link.folderId);
        if (node) {
            $bookmark.removeClass('enabled').addClass('removed');
            link.removed = true;
            // il link verrà  ripristinato se viene cliccato il toast prima che scomapia
            var undoKey = undo.add($bookmark.get(0));
            toastr.warning('<b>' + link.text + '</b> removed (click to undo)').click(function() {
                var $undo = $(undo.undo(undoKey));
                if ($undo.length) {
                    $undo.data('source').removed = false;
                    $undo.addClass('enabled').removeClass('removed');
                }
            });
        }
    }

    function deleteLink($bookmark) {
        // elimina definitivamente un link, senza possibilità di undo
        var link = $bookmark.data('source');
        var node = getNodeByFolderId(link.folderId);
        if (node) {
            $bookmark.remove();
            var pos = _.indexOf(node.links, link);
            if (pos >= 0) node.links.splice(pos, 1);
        }
    }

    function prepareNewLink() {
        var node = $('#folders').treeview(true).getSelected()[0];
        var link = createLink('http://', '', 'Bookmark title', node.folderId);
        (node.links || (node.links = [])).push(link);
        beginEditMode(link, createLinkDom($('#links'), link).addClass('new').show());
    }

    function parseBookmarkFile(context) {
        var root = [createFolder($(context).find('dt:first>h3').html(), 0)];
        parseDL(root[0], $(context).find('dl').first(), 0);
        return root;
    }

    function parseDL(parent, context, folderId) {
        context.children('dt').each(function() {
            var $self = $(this);
            if ($self.has('h3').length) { // folder
                var folder = createFolder($self.find('h3').first().html(), ++folderId);
                (parent.nodes || (parent.nodes = [])).push(folder);
                folderId = parseDL(folder, $self.children('dl'), folderId);
            } else { // node
                parseLink($self, parent);
            }
        });
        return folderId;
    }

    function parseLink($dt, parent) {
        var link = $dt.find('a').first();
        (parent.links || (parent.links = [])).push(createLink(link.attr('href'), link.attr('icon'), link.html(), parent.folderId));
    }

    function createFolder(text, folderId) {
        return {
            "text": text,
            "folderId": folderId
        };
    }

    function createLink(href, icon, text, folderId) {
        return {
            "href": href,
            "icon": icon,
            "text": text,
            "rating": 1,
            // NB: non ne ho la certezza ma dovrebbe corrispondere a nodeId (-> viene creato solo dopo la creazione del controllo)
            "folderId": folderId,
            // NB: stati bookmark -> enabled, removed
            "status": "enabled"
        };
    }

    function getNodeByFolderId(folderId) {
        // in teoria folderId equivale a nodeId e quindi può essere usato per recuperare il nodo
        var node = $('#folders').treeview(true).getNode(folderId);
        if (node.nodeId !== node.folderId) {
            console.log('ERR: node not found for id', folderId);
            return null;
        } else {
            return node;
        }
    }

    function prepareSearch() {
        var searchEl = $('#txtsearch');
        Rx.Observable.merge(
                Rx.Observable.fromEvent(searchEl, 'keyup'),
                Rx.Observable.fromEvent(searchEl, 'blur'))
            .map(function(event) {
                return event.target.value.trim();
            })
            .filter(function(text) {
                return text.length === 0 || text.length >= 2;
            })
            .debounce(500) //se non succede più niente per 500ms prosegue
            .distinctUntilChanged() //solo quando cambia
            .subscribe(performSearch);
    }

    function performSearch(term) {
        // deleleziono la cartella
        _.each($('#folders').treeview(true).getSelected(),
            function(node) {
                $('#folders').treeview('unselectNode', node);
            });
        // nascondo il pulsante add
        $('#btnadd').hide();
        // se il termine di ricerca è vuoto nascondo tutto altrimenti visualizzo solo i bookmark che lo soddisfano
        if (_.isEmpty(term)) {
            // TODO: selezionare l'ultimo nodo selezionato
            $('.bookmark.enabled').hide();
        } else {
            // salvo l'ultimo termine di ricerca non vuoto
            $('#txtsearch').data('last-term', term);
            // ricerca su tutti i link
            var re = new RegExp(term, 'i');
            $('.bookmark.enabled')
                .hide()
                .filter(function(index, el) {
                    // TODO: cercare anche in altre proprietà
                    return re.test($(el).data('source').text);
                })
                .do(function() {
                    // riporto il numero di link trovati
                    $('#itemsearch').show().addClass('active').find('.badge').html(this.length);
                })
                .show();
        }
    }

    // esegue una funziona all'interno della chain
    $.fn.do = function(func) {
        // TODO: do, gestire each
        if (func) {
            func.apply(this);
        }
        return this;
    };
    // copia il contenuto di un tag in una proprietà di un oggetto
    $.fn.copyHtmlTo = function(obj, property) {
        // TODO: copyHtmlTo, gestire each
        obj[property] = this.html();
        return this;
    };
    //
    $.fn.gotoNext = function() {
        debugger
        var $end = this.end();
        var index = this.index();
        if (index === $end.length - 1) index = 0;
        return $end.eq(this.index() + 1);
    };
    //
    var undo = (function() {
        var map = {};
        // TODO: rendere key univoco
        var key = 0;
        return {
            add: function() {
                map[++key] = Array.prototype.slice.apply(arguments);
                return key;
            },
            undo: function(key) {
                var value = map[key];
                delete map[key];
                return value;
            }
        };
    })();
    </script>
</body>

</html>
